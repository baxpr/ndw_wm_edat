Bootstrap: docker
From: ubuntu:16.04

%help
NDW_WM_EDAT_v2
Computes d prime, accuracy, reaction time for NDW working memory study.

TO BUILD
  sudo singularity build NDW_WM_EDAT_v2.simg Singularity

TO RUN
  singularity run --cleanenv -B INPUTS:/INPUTS,OUTPUTS:/OUTPUTS NDW_WM_EDAT_v2.simg \
    /INPUTS /OUTPUTS

INPUTS
In the bound INPUTS directory, place the EDAT_CONVERTED resources from all usable
"Working Memory" scans in the session. These are assumed to end in '.txt' and it
should be fine to use the existing filenames. All '.txt' files in the INPUTS 
directory will be assumed to be EDAT files.

Also, place files in the INPUTS directory named 'project', 'subject', 'session', 
each containing the corresponding information. (Note - if you'd rather pass
these on the singularity command line, I can make that happen)

OUTPUTS
report.pdf,PDF
summary.csv,STATS
trialinfo.csv,TRIALINFO


%files
  # Build from masimatlab/trunk/xnatspiders/matlab/NDW_wm_edat_v2 for this to work 
  . /code

%labels
  Name NDW_WM_EDAT_v2
  Maintainer baxter.rogers@vanderbilt.edu

%post
  apt-get update
  apt-get install -y wget unzip zip xvfb ghostscript openjdk-8-jre
  
  # Download the Matlab Compiled Runtime installer
  mkdir /MCR
  wget -P/MCR http://ssd.mathworks.com/supportfiles/downloads/R2017a/deployment_files/R2017a/installers/glnxa64/MCR_R2017a_glnxa64_installer.zip

  # Install the MCR, then clean up. unzip needs a fully qualified output path
  unzip /MCR/MCR_R2017a_glnxa64_installer.zip -d /MCR/MCR_R2017a_glnxa64_installer
  /MCR/MCR_R2017a_glnxa64_installer/install -mode silent -agreeToLicense yes
  rm -fr /MCR/MCR_R2017a_glnxa64_installer /MCR/MCR_R2017a_glnxa64_installer.zip

  # Create input/output directories for binding
  mkdir /INPUTS && mkdir /OUTPUTS

%environment
  # Set Matlab library path
  LD_LIBRARY_PATH=/usr/local/MATLAB/MATLAB_Runtime/v92/runtime/glnxa64:/usr/local/MATLAB/MATLAB_Runtime/v92/bin/glnxa64:/usr/local/MATLAB/MATLAB_Runtime/v92/sys/os/glnxa64:${LD_LIBRARY_PATH}
  XAPPLRESDIR=/usr/local/MATLAB/MATLAB_Runtime/v92/X11/app-defaults
  export LD_LIBRARY_PATH XAPPLRESDIR

%runscript
  cd /code && \
    xvfb-run --server-num=$(($$ + 99)) \
    --server-args='-screen 0 1600x1200x24 -ac +extension GLX' \
    ./run_NDW_WM_EDAT_v2.sh \
    /usr/local/MATLAB/MATLAB_Runtime/v92 \
    "$@"
